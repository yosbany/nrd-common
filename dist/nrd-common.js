!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.NRDCommon=t():e.NRDCommon=t()}(this,()=>(()=>{"use strict";var e={d:(t,n)=>{for(var o in n)e.o(n,o)&&!e.o(t,o)&&Object.defineProperty(t,o,{enumerable:!0,get:n[o]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};e.r(t),e.d(t,{AuthService:()=>F,DEFAULT_LOG_LEVEL:()=>l,INIT_TIMEOUT:()=>s,LOG_COLORS:()=>o,LOG_LEVELS:()=>n,Logger:()=>i,MODULE_CHECK_INTERVAL:()=>a,NavigationService:()=>j,REQUIRED_GLOBALS:()=>d,REQUIRED_MODULES:()=>c,createElement:()=>T,createLogger:()=>r,default:()=>H,escapeHtml:()=>k,formatCurrency:()=>A,formatDate:()=>M,formatDecimalWithComma:()=>x,formatNumber:()=>C,getMonthName:()=>O,hideSpinner:()=>I,initializeApplication:()=>p,initializeNRD:()=>f,isDateInRange:()=>U,isEmployeeActiveInYear:()=>P,parseDecimalWithComma:()=>R,querySelectorSafe:()=>B,showAlert:()=>y,showConfirm:()=>v,showError:()=>S,showErrorAlert:()=>b,showInfo:()=>L,showInitError:()=>g,showSpinner:()=>N,showSuccess:()=>E,showWarning:()=>D,verifyModules:()=>w,waitForAllScripts:()=>m,waitForGlobal:()=>u,waitForGlobals:()=>h,waitForNRD:()=>z,waitForServices:()=>G});const n={DEBUG:0,INFO:1,WARN:2,ERROR:3,AUDIT:4},o={DEBUG:"#6B7280",INFO:"#3B82F6",WARN:"#F59E0B",ERROR:"#EF4444",AUDIT:"#10B981"};class i{constructor(e,t={}){this.appName=e,this.logLevel=void 0!==t.logLevel?t.logLevel:n.INFO,this.enableColors=void 0===t.enableColors||t.enableColors,this.enableTimestamp=void 0===t.enableTimestamp||t.enableTimestamp,this.enableStack=void 0!==t.enableStack&&t.enableStack}getTimestamp(){return this.enableTimestamp?(new Date).toISOString():""}formatMessage(e,t,o=null){const i=this.getTimestamp(),r=Object.keys(n).find(t=>n[t]===e),s=[];return i&&s.push(`[${i}]`),s.push(`[${this.appName}]`),s.push(`[${r}]`),s.push(t),s.join(" ")}formatData(e){if(null==e)return null;if(e instanceof Error)return{name:e.name,message:e.message,stack:this.enableStack?e.stack:void 0};try{return JSON.parse(JSON.stringify(e))}catch(t){return String(e)}}log(e,t,i=null){if(e<this.logLevel)return;const r=this.formatMessage(e,t,i),s=this.formatData(i),a=Object.keys(n).find(t=>n[t]===e),d=this.enableColors?o[a]:null,c=e===n.ERROR?console.error:e===n.WARN?console.warn:console.log;d&&this.enableColors?c(`%c${r}`,`color: ${d}; font-weight: bold`,s||""):c(r,s||"")}debug(e,t=null){this.log(n.DEBUG,e,t)}info(e,t=null){this.log(n.INFO,e,t)}warn(e,t=null){this.log(n.WARN,e,t)}error(e,t=null){this.log(n.ERROR,e,t)}audit(e,t=null){const o={action:e,timestamp:(new Date).toISOString(),user:this.getCurrentUser(),details:t};this.log(n.AUDIT,`AUDIT: ${e}`,o)}getCurrentUser(){try{if("undefined"!=typeof window&&window.nrd&&window.nrd.auth){const e=window.nrd.auth.getCurrentUser();return e?{uid:e.uid,email:e.email}:null}return null}catch(e){return null}}group(e){console.group(`[${this.appName}] ${e}`)}groupEnd(){console.groupEnd()}time(e){console.time(`[${this.appName}] ${e}`)}timeEnd(e){console.timeEnd(`[${this.appName}] ${e}`)}}function r(e,t={}){return new i(e,{logLevel:void 0!==t.logLevel?t.logLevel:n.INFO,enableColors:void 0===t.enableColors||t.enableColors,enableTimestamp:void 0===t.enableTimestamp||t.enableTimestamp,enableStack:void 0!==t.enableStack&&t.enableStack})}const s=15e3,a=100,d=["NRDDataAccess","logger"],c=["showAlert","showSpinner","hideSpinner","showConfirm","window.nrd"],l="INFO";function u(e,t=s){return new Promise(n=>{if(void 0!==window[e])return void n(!0);const o=Date.now(),i=setInterval(()=>{void 0!==window[e]?(clearInterval(i),n(!0)):Date.now()-o>=t&&(clearInterval(i),n(!1))},a)})}function m(e=s){return new Promise(t=>{if("complete"===document.readyState)return void setTimeout(()=>t(!0),100);const n=Date.now();window.addEventListener("load",()=>{setTimeout(()=>t(!0),100)}),setTimeout(()=>{Date.now()-n>=e&&t(!1)},e)})}function h(e,t=s){const n=Array.isArray(e)?e:[e];return new Promise(e=>{const o=Date.now(),i=()=>{n.every(e=>{const t=e.split(".");let n=window;for(const e of t){if(!n||void 0===n[e])return!1;n=n[e]}return!0})?e(!0):Date.now()-o>=t?e(!1):setTimeout(i,a)};i()})}async function w(){const e=[];for(const t of c)await h(t,5e3)||e.push(t);return{success:0===e.length,missing:e}}function g(e,t,n=""){const o=`\n    <div class="min-h-screen flex items-center justify-center bg-white">\n      <div class="text-center max-w-md px-4">\n        <h1 class="text-xl font-light mb-4 text-gray-800">${e}</h1>\n        <p class="text-gray-600 mb-2">${t}</p>\n        ${n?`<p class="text-sm text-gray-500 mt-2">${n}</p>`:""}\n      </div>\n    </div>\n  `;document.body.innerHTML=o}async function f(){try{return await u("NRDDataAccess",1e4)?(window.nrd=new NRDDataAccess,console.log("NRD Data Access initialized successfully"),!0):(console.error("NRD Data Access Library not loaded after timeout"),g("Error de Carga","No se pudo cargar la librería NRD Data Access","Por favor, verifica tu conexión y recarga la página."),!1)}catch(e){return console.error("Error initializing NRD Data Access:",e),g("Error de Inicialización",`Error al inicializar la aplicación: ${e.message||"Error desconocido"}`,"Por favor, recarga la página."),!1}}async function p(){try{console.log("Waiting for all scripts to load..."),await m(s)||console.warn("Scripts may not have loaded completely, continuing anyway..."),console.log("Verifying required modules...");const e=await w();if(!e.success)return console.error("Missing required modules:",e.missing),void g("Error de Carga","No se pudieron cargar todos los módulos necesarios",`Módulos faltantes: ${e.missing.join(", ")}. Por favor, recarga la página.`);console.log("All modules loaded successfully. Application ready.")}catch(e){console.error("Error during application initialization:",e),g("Error de Inicialización",`Error al inicializar la aplicación: ${e.message||"Error desconocido"}`,"Por favor, recarga la página.")}}function v(e,t,n="Confirmar",o="Cancelar"){return new Promise(i=>{const r=document.getElementById("custom-modal"),s=document.getElementById("modal-title"),a=document.getElementById("modal-message"),d=document.getElementById("modal-confirm"),c=document.getElementById("modal-cancel");s.textContent=e,a.textContent=t,d.textContent=n,c.textContent=o,r.classList.remove("hidden");const l=()=>{r.classList.add("hidden"),d.removeEventListener("click",l),c.removeEventListener("click",u),i(!0)},u=()=>{r.classList.add("hidden"),d.removeEventListener("click",l),c.removeEventListener("click",u),i(!1)};d.addEventListener("click",l),c.addEventListener("click",u);const m=e=>{e.target===r&&(u(),r.removeEventListener("click",m))};r.addEventListener("click",m)})}function y(e,t){return new Promise(n=>{const o=document.getElementById("custom-alert"),i=document.getElementById("alert-title"),r=document.getElementById("alert-message"),s=document.getElementById("alert-ok");i.textContent=e,r.textContent=t,o.classList.remove("hidden");const a=()=>{o.classList.add("hidden"),s.removeEventListener("click",a),n()};s.addEventListener("click",a);const d=e=>{e.target===o&&(a(),o.removeEventListener("click",d))};o.addEventListener("click",d)})}function E(e){return y("Éxito",e)}function b(e){return y("Error",e)}function S(e){return b(e)}function L(e){return y("Información",e)}function D(e){return y("Advertencia",e)}function N(e="Cargando..."){const t=document.getElementById("loading-spinner"),n=t.querySelector("p");n&&(n.textContent=e),t.classList.remove("hidden")}function I(){document.getElementById("loading-spinner").classList.add("hidden")}function C(e,t=0){if(null==e||isNaN(e))return"0,00";const n=Math.round(parseFloat(e));return isNaN(n)?"0,00":`${n.toString().replace(/\B(?=(\d{3})+(?!\d))/g,".")},00`}function A(e,t=0){return`$${C(e,t)}`}function R(e){if(!e||""===e)return null;const t=String(e).replace(",","."),n=parseFloat(t);return isNaN(n)?null:n}function x(e){return null==e||isNaN(e)?"":String(e).replace(".",",")}function k(e){if(!e)return"";const t=document.createElement("div");return t.textContent=e,t.innerHTML}function B(e,t=document){try{return t.querySelector(e)}catch(e){return null}}function T(e,t={},n=[]){const o=document.createElement(e);return Object.entries(t).forEach(([e,t])=>{"className"===e?o.className=t:"textContent"===e?o.textContent=t:"innerHTML"===e?o.innerHTML=t:o.setAttribute(e,t)}),n.forEach(e=>{"string"==typeof e?o.appendChild(document.createTextNode(e)):e instanceof Node&&o.appendChild(e)}),o}function O(e){return["Ene","Feb","Mar","Abr","May","Jun","Jul","Ago","Sep","Oct","Nov","Dic"][e-1]||""}function M(e,t="DD/MM/YYYY"){if(!e)return"";const n=e instanceof Date?e:new Date(e);if(isNaN(n.getTime()))return"";const o=String(n.getDate()).padStart(2,"0"),i=String(n.getMonth()+1).padStart(2,"0"),r=n.getFullYear();return t.replace("DD",o).replace("MM",i).replace("YYYY",r)}function U(e,t,n){if(!e)return!1;const o=e instanceof Date?e:new Date(e),i=t instanceof Date?t:new Date(t),r=n instanceof Date?n:new Date(n);return o>=i&&o<=r}function P(e,t){if(!e)return!1;const n=new Date(t,0,1),o=new Date(t,11,31);return!(e.startDate&&new Date(e.startDate)>o)&&!(e.endDate&&new Date(e.endDate)<n)}"undefined"!=typeof window&&(window.showConfirm=v,window.showAlert=y,window.showSuccess=E,window.showError=S,window.showErrorAlert=b,window.showInfo=L),"undefined"!=typeof window&&(window.showSpinner=N,window.hideSpinner=I),"undefined"!=typeof window&&(window.formatNumber=C,window.formatCurrency=A,window.parseDecimalWithComma=R,window.formatDecimalWithComma=x),"undefined"!=typeof window&&(window.escapeHtml=k),"undefined"!=typeof window&&(window.getMonthName=O,window.isEmployeeActiveInYear=P);const $="undefined"!=typeof window&&window.logger||console;class F{constructor(e){this.nrd=e,this.currentUser=null,this.authCheckComplete=!1,this.unsubscribe=null,this.init()}init(){this.nrd&&this.nrd.auth?(this.unsubscribe=this.nrd.auth.onAuthStateChanged(e=>{try{this.authCheckComplete=!0,this.currentUser=e,this.hideRedirectingScreen(),e?($.info("User authenticated, showing app screen",{uid:e.uid,email:e.email}),this.showAppScreen()):($.info("User not authenticated, showing login screen"),this.showLoginScreen())}catch(e){$.error("Error in auth state change",e),this.hideRedirectingScreen();const t=document.getElementById("login-screen"),n=document.getElementById("app-screen");t&&t.classList.remove("hidden"),n&&n.classList.add("hidden")}}),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>this.initAuthCheck()):this.initAuthCheck(),this.setupLoginForm(),this.setupProfileHandlers()):($.error("nrd or nrd.auth is not available"),this.showRedirectingScreen(),setTimeout(()=>{this.hideRedirectingScreen(),this.showLoginScreen()},300))}showRedirectingScreen(){const e=document.getElementById("redirecting-screen"),t=document.getElementById("login-screen"),n=document.getElementById("app-screen");e&&e.classList.remove("hidden"),t&&t.classList.add("hidden"),n&&n.classList.add("hidden")}hideRedirectingScreen(){const e=document.getElementById("redirecting-screen");e&&e.classList.add("hidden")}hasStoredToken(){try{return Object.keys(localStorage).filter(e=>e.startsWith("firebase:authUser:")).length>0}catch(e){return $.error("Error checking stored token",e),!1}}initAuthCheck(){this.showRedirectingScreen(),this.hasStoredToken()?($.debug("Stored token found, waiting for auth state change"),setTimeout(()=>{this.authCheckComplete||($.info("Token found but authentication not restored, showing login"),this.hideRedirectingScreen(),this.showLoginScreen())},2e3)):($.debug("No stored token found, showing login immediately"),setTimeout(()=>{this.hideRedirectingScreen(),this.showLoginScreen()},300))}showLoginScreen(){$.debug("Showing login screen");try{const e=document.getElementById("login-screen"),t=document.getElementById("app-screen");e&&e.classList.remove("hidden"),t&&t.classList.add("hidden")}catch(e){$.error("Error showing login screen",e)}}showAppScreen(){$.debug("Showing app screen");try{const e=document.getElementById("login-screen"),t=document.getElementById("app-screen");e&&e.classList.add("hidden"),t&&t.classList.remove("hidden"),setTimeout(()=>{"function"==typeof window.switchView&&($.debug("Switching to default view: dashboard"),window.switchView("dashboard"))},100)}catch(e){$.error("Error showing app screen",e)}}setupLoginForm(){const e=document.getElementById("login-form");e&&e.addEventListener("submit",async e=>{e.preventDefault();try{const e=document.getElementById("login-email")?.value,t=document.getElementById("login-password")?.value,n=document.getElementById("login-error");if(!e||!t)return $.warn("Login attempt with empty fields"),void(n&&(n.textContent="Por favor complete todos los campos"));if($.info("Attempting user login",{email:e}),n&&(n.textContent=""),!this.nrd||!this.nrd.auth)return $.error("nrd or nrd.auth is not available"),void(n&&(n.textContent="Error: Servicio no disponible"));N("Iniciando sesión...");const o=(await this.nrd.auth.signIn(e,t)).user;$.audit("USER_LOGIN",{email:e,uid:o.uid,timestamp:Date.now()}),$.info("User login successful",{uid:o.uid,email:e}),I()}catch(e){I(),$.error("Login failed",e);const t=document.getElementById("login-error");t&&(t.textContent=e.message||"Error al iniciar sesión")}})}setupProfileHandlers(){const e=document.getElementById("profile-btn");e&&e.addEventListener("click",()=>{this.showProfileModal()});const t=document.getElementById("close-profile-modal");t&&t.addEventListener("click",()=>{this.closeProfileModal()});const n=document.getElementById("profile-logout-btn");n&&n.addEventListener("click",async()=>{try{const e=this.getCurrentUser();if($.info("Attempting user logout",{uid:e?.uid,email:e?.email}),this.closeProfileModal(),!this.nrd||!this.nrd.auth)return void $.error("nrd or nrd.auth is not available");N("Cerrando sesión..."),await this.nrd.auth.signOut(),$.audit("USER_LOGOUT",{uid:e?.uid,email:e?.email,timestamp:Date.now()}),$.info("User logout successful"),I()}catch(e){I(),$.error("Logout failed",e)}})}showProfileModal(){$.debug("Showing profile modal");const e=document.getElementById("profile-modal"),t=document.getElementById("profile-modal-content");if(!e||!t)return void $.warn("Profile modal elements not found");const n=this.getCurrentUser();if(!n)return void $.warn("No user found when showing profile modal");$.debug("Displaying user profile data",{uid:n.uid,email:n.email});let o=`\n      <div class="space-y-3 sm:space-y-4">\n        <div class="flex justify-between py-2 sm:py-3 border-b border-gray-200">\n          <span class="text-gray-600 font-light text-sm sm:text-base">Email:</span>\n          <span class="font-light text-sm sm:text-base">${k(n.email||"N/A")}</span>\n        </div>\n        ${n.displayName?`\n        <div class="flex justify-between py-2 sm:py-3 border-b border-gray-200">\n          <span class="text-gray-600 font-light text-sm sm:text-base">Nombre:</span>\n          <span class="font-light text-sm sm:text-base">${k(n.displayName)}</span>\n        </div>\n        `:""}\n      </div>\n    `;t.innerHTML=o,e.classList.remove("hidden"),$.debug("Profile modal shown")}closeProfileModal(){$.debug("Closing profile modal");const e=document.getElementById("profile-modal");e&&(e.classList.add("hidden"),$.debug("Profile modal closed"))}getCurrentUser(){return this.nrd&&this.nrd.auth&&this.nrd.auth.getCurrentUser()||this.currentUser}destroy(){this.unsubscribe&&(this.unsubscribe(),this.unsubscribe=null)}}const V="undefined"!=typeof window&&window.logger||console;class j{constructor(){this.currentView=null,this.views=["dashboard","payroll-items"],this.viewHandlers=new Map}registerView(e,t){this.viewHandlers.set(e,t)}switchView(e){if(this.currentView===e)return void V.debug("View already active, skipping",{viewName:e});V.info("Switching view",{from:this.currentView,to:e}),this.currentView=e,this.views.forEach(e=>{const t=document.getElementById(`${e}-view`);t&&t.classList.add("hidden")});const t=document.getElementById(`${e}-view`);t?(t.classList.remove("hidden"),V.debug("View shown",{viewName:e})):V.warn("View element not found",{viewName:e}),document.querySelectorAll(".nav-btn").forEach(e=>{e.classList.remove("border-red-600","text-red-600","bg-red-50","font-medium"),e.classList.add("border-transparent","text-gray-600")});const n=document.querySelector(`[data-view="${e}"]`);n?(n.classList.remove("border-transparent","text-gray-600"),n.classList.add("border-red-600","text-red-600","bg-red-50","font-medium")):V.warn("Active nav button not found",{viewName:e}),V.debug("Loading view data",{viewName:e});const o=this.viewHandlers.get(e);o?o():"dashboard"===e?"function"==typeof window.initializeDashboard?window.initializeDashboard():"function"==typeof window.loadDashboard&&window.loadDashboard():"payroll-items"===e&&("function"==typeof window.initializePayrollItems?window.initializePayrollItems():"function"==typeof window.loadPayrollItems&&window.loadPayrollItems()),V.debug("View switched successfully",{viewName:e})}setupNavButtons(){V.debug("Setting up nav button handlers"),document.querySelectorAll(".nav-btn").forEach(e=>{const t=e.cloneNode(!0);e.parentNode.replaceChild(t,e),t.addEventListener("click",()=>{const e=t.dataset.view;V.debug("Nav button clicked",{view:e}),this.switchView(e)})}),V.debug("Nav button handlers attached")}getCurrentView(){return this.currentView}}function z(e=5e3){return new Promise((t,n)=>{const o=Date.now(),i=()=>{const r=window.nrd;r?t(r):Date.now()-o>=e?n(new Error("NRD instance not found")):setTimeout(i,100)};i()})}function G(e,t=null,n=5e3){return new Promise((o,i)=>{const r=Date.now(),s=()=>{const a=t||window.nrd;if(!a)return Date.now()-r>=n?void i(new Error("NRD instance not found")):void setTimeout(s,100);e.every(e=>void 0!==a[e])?o(a):Date.now()-r>=n?i(new Error(`Services not available after timeout: ${e.join(", ")}`)):setTimeout(s,100)};s()})}"undefined"!=typeof window&&(window.switchView=function(e){window.navigationService&&window.navigationService.switchView(e)});const H={Logger:i,LOG_LEVELS:n,createLogger:r,waitForGlobal:u,waitForAllScripts:m,waitForGlobals:h,verifyModules:w,initializeNRD:f,initializeApplication:p,showConfirm:v,showAlert:y,showError:S,showErrorAlert:b,showSuccess:E,showInfo:L,showWarning:D,showSpinner:N,hideSpinner:I,formatNumber:C,formatCurrency:A,formatDecimalWithComma:x,parseDecimalWithComma:R,escapeHtml:k,querySelectorSafe:B,createElement:T,getMonthName:O,formatDate:M,isEmployeeActiveInYear:P,AuthService:F,NavigationService:j,waitForNRD:z,waitForServices:G};return t})());