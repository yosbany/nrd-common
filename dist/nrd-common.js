!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.NRDCommon=t():e.NRDCommon=t()}(this,()=>(()=>{"use strict";var e={d:(t,n)=>{for(var o in n)e.o(n,o)&&!e.o(t,o)&&Object.defineProperty(t,o,{enumerable:!0,get:n[o]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};e.r(t),e.d(t,{AuthService:()=>F,DEFAULT_LOG_LEVEL:()=>u,INIT_TIMEOUT:()=>a,LOG_COLORS:()=>r,LOG_LEVELS:()=>o,Logger:()=>i,MODULE_CHECK_INTERVAL:()=>l,NavigationService:()=>V,REQUIRED_GLOBALS:()=>d,REQUIRED_MODULES:()=>c,createElement:()=>O,createLogger:()=>s,default:()=>_,escapeHtml:()=>B,formatCurrency:()=>R,formatDate:()=>U,formatDecimalWithComma:()=>k,formatNumber:()=>A,getMonthName:()=>M,hideSpinner:()=>C,initializeApplication:()=>v,initializeNRD:()=>p,isDateInRange:()=>P,isEmployeeActiveInYear:()=>$,parseDecimalWithComma:()=>x,querySelectorSafe:()=>T,showAlert:()=>E,showConfirm:()=>y,showError:()=>L,showErrorAlert:()=>S,showInfo:()=>D,showInitError:()=>f,showSpinner:()=>I,showSuccess:()=>b,showWarning:()=>N,verifyModules:()=>w,waitForAllScripts:()=>m,waitForGlobal:()=>g,waitForGlobals:()=>h,waitForNRD:()=>j,waitForServices:()=>z});var n={};e.r(n),e.d(n,{Uq:()=>r,p_:()=>o,Vy:()=>i,h:()=>s});const o={DEBUG:0,INFO:1,WARN:2,ERROR:3,AUDIT:4},r={DEBUG:"#6B7280",INFO:"#3B82F6",WARN:"#F59E0B",ERROR:"#EF4444",AUDIT:"#10B981"};class i{constructor(e,t={}){this.appName=e,this.logLevel=void 0!==t.logLevel?t.logLevel:o.INFO,this.enableColors=void 0===t.enableColors||t.enableColors,this.enableTimestamp=void 0===t.enableTimestamp||t.enableTimestamp,this.enableStack=void 0!==t.enableStack&&t.enableStack}getTimestamp(){return this.enableTimestamp?(new Date).toISOString():""}formatMessage(e,t,n=null){const r=this.getTimestamp(),i=Object.keys(o).find(t=>o[t]===e),s=[];return r&&s.push(`[${r}]`),s.push(`[${this.appName}]`),s.push(`[${i}]`),s.push(t),s.join(" ")}formatData(e){if(null==e)return null;if(e instanceof Error)return{name:e.name,message:e.message,stack:this.enableStack?e.stack:void 0};try{return JSON.parse(JSON.stringify(e))}catch(t){return String(e)}}log(e,t,n=null){if(e<this.logLevel)return;const i=this.formatMessage(e,t,n),s=this.formatData(n),a=Object.keys(o).find(t=>o[t]===e),l=this.enableColors?r[a]:null,d=e===o.ERROR?console.error:e===o.WARN?console.warn:console.log;l&&this.enableColors?d(`%c${i}`,`color: ${l}; font-weight: bold`,s||""):d(i,s||"")}debug(e,t=null){this.log(o.DEBUG,e,t)}info(e,t=null){this.log(o.INFO,e,t)}warn(e,t=null){this.log(o.WARN,e,t)}error(e,t=null){this.log(o.ERROR,e,t)}audit(e,t=null){const n={action:e,timestamp:(new Date).toISOString(),user:this.getCurrentUser(),details:t};this.log(o.AUDIT,`AUDIT: ${e}`,n)}getCurrentUser(){try{if("undefined"!=typeof window&&window.nrd&&window.nrd.auth){const e=window.nrd.auth.getCurrentUser();return e?{uid:e.uid,email:e.email}:null}return null}catch(e){return null}}group(e){console.group(`[${this.appName}] ${e}`)}groupEnd(){console.groupEnd()}time(e){console.time(`[${this.appName}] ${e}`)}timeEnd(e){console.timeEnd(`[${this.appName}] ${e}`)}}function s(e,t={}){return new i(e,{logLevel:void 0!==t.logLevel?t.logLevel:o.INFO,enableColors:void 0===t.enableColors||t.enableColors,enableTimestamp:void 0===t.enableTimestamp||t.enableTimestamp,enableStack:void 0!==t.enableStack&&t.enableStack})}const a=15e3,l=100,d=["NRDDataAccess","logger"],c=["showAlert","showSpinner","hideSpinner","showConfirm","window.nrd"],u="INFO";function g(e,t=a){return new Promise(n=>{if(void 0!==window[e])return void n(!0);const o=Date.now(),r=setInterval(()=>{void 0!==window[e]?(clearInterval(r),n(!0)):Date.now()-o>=t&&(clearInterval(r),n(!1))},l)})}function m(e=a){return new Promise(t=>{if("complete"===document.readyState)return void setTimeout(()=>t(!0),100);const n=Date.now();window.addEventListener("load",()=>{setTimeout(()=>t(!0),100)}),setTimeout(()=>{Date.now()-n>=e&&t(!1)},e)})}function h(e,t=a){const n=Array.isArray(e)?e:[e];return new Promise(e=>{const o=Date.now(),r=()=>{n.every(e=>{const t=e.split(".");let n=window;for(const e of t){if(!n||void 0===n[e])return!1;n=n[e]}return!0})?e(!0):Date.now()-o>=t?e(!1):setTimeout(r,l)};r()})}async function w(){const e=[];for(const t of c)await h(t,5e3)||e.push(t);return{success:0===e.length,missing:e}}function f(e,t,n=""){const o=`\n    <div class="min-h-screen flex items-center justify-center bg-white">\n      <div class="text-center max-w-md px-4">\n        <h1 class="text-xl font-light mb-4 text-gray-800">${e}</h1>\n        <p class="text-gray-600 mb-2">${t}</p>\n        ${n?`<p class="text-sm text-gray-500 mt-2">${n}</p>`:""}\n      </div>\n    </div>\n  `;document.body.innerHTML=o}async function p(){try{return await g("NRDDataAccess",1e4)?(window.nrd=new NRDDataAccess,console.log("NRD Data Access initialized successfully"),!0):(console.error("NRD Data Access Library not loaded after timeout"),f("Error de Carga","No se pudo cargar la librería NRD Data Access","Por favor, verifica tu conexión y recarga la página."),!1)}catch(e){return console.error("Error initializing NRD Data Access:",e),f("Error de Inicialización",`Error al inicializar la aplicación: ${e.message||"Error desconocido"}`,"Por favor, recarga la página."),!1}}async function v(){try{console.log("Waiting for all scripts to load..."),await m(a)||console.warn("Scripts may not have loaded completely, continuing anyway..."),console.log("Verifying required modules...");const e=await w();if(!e.success)return console.error("Missing required modules:",e.missing),void f("Error de Carga","No se pudieron cargar todos los módulos necesarios",`Módulos faltantes: ${e.missing.join(", ")}. Por favor, recarga la página.`);console.log("All modules loaded successfully. Application ready.")}catch(e){console.error("Error during application initialization:",e),f("Error de Inicialización",`Error al inicializar la aplicación: ${e.message||"Error desconocido"}`,"Por favor, recarga la página.")}}function y(e,t,n="Confirmar",o="Cancelar"){return new Promise(r=>{const i=document.getElementById("custom-modal"),s=document.getElementById("modal-title"),a=document.getElementById("modal-message"),l=document.getElementById("modal-confirm"),d=document.getElementById("modal-cancel");s.textContent=e,a.textContent=t,l.textContent=n,d.textContent=o,i.classList.remove("hidden");const c=()=>{i.classList.add("hidden"),l.removeEventListener("click",c),d.removeEventListener("click",u),r(!0)},u=()=>{i.classList.add("hidden"),l.removeEventListener("click",c),d.removeEventListener("click",u),r(!1)};l.addEventListener("click",c),d.addEventListener("click",u);const g=e=>{e.target===i&&(u(),i.removeEventListener("click",g))};i.addEventListener("click",g)})}function E(e,t){return new Promise(n=>{const o=document.getElementById("custom-alert"),r=document.getElementById("alert-title"),i=document.getElementById("alert-message"),s=document.getElementById("alert-ok");r.textContent=e,i.textContent=t,o.classList.remove("hidden");const a=()=>{o.classList.add("hidden"),s.removeEventListener("click",a),n()};s.addEventListener("click",a);const l=e=>{e.target===o&&(a(),o.removeEventListener("click",l))};o.addEventListener("click",l)})}function b(e){return E("Éxito",e)}function S(e){return E("Error",e)}function L(e){return S(e)}function D(e){return E("Información",e)}function N(e){return E("Advertencia",e)}function I(e="Cargando..."){const t=document.getElementById("loading-spinner"),n=t.querySelector("p");n&&(n.textContent=e),t.classList.remove("hidden")}function C(){document.getElementById("loading-spinner").classList.add("hidden")}function A(e,t=0){if(null==e||isNaN(e))return"0,00";const n=Math.round(parseFloat(e));return isNaN(n)?"0,00":`${n.toString().replace(/\B(?=(\d{3})+(?!\d))/g,".")},00`}function R(e,t=0){return`$${A(e,t)}`}function x(e){if(!e||""===e)return null;const t=String(e).replace(",","."),n=parseFloat(t);return isNaN(n)?null:n}function k(e){return null==e||isNaN(e)?"":String(e).replace(".",",")}function B(e){if(!e)return"";const t=document.createElement("div");return t.textContent=e,t.innerHTML}function T(e,t=document){try{return t.querySelector(e)}catch(e){return null}}function O(e,t={},n=[]){const o=document.createElement(e);return Object.entries(t).forEach(([e,t])=>{"className"===e?o.className=t:"textContent"===e?o.textContent=t:"innerHTML"===e?o.innerHTML=t:o.setAttribute(e,t)}),n.forEach(e=>{"string"==typeof e?o.appendChild(document.createTextNode(e)):e instanceof Node&&o.appendChild(e)}),o}function M(e){return["Ene","Feb","Mar","Abr","May","Jun","Jul","Ago","Sep","Oct","Nov","Dic"][e-1]||""}function U(e,t="DD/MM/YYYY"){if(!e)return"";const n=e instanceof Date?e:new Date(e);if(isNaN(n.getTime()))return"";const o=String(n.getDate()).padStart(2,"0"),r=String(n.getMonth()+1).padStart(2,"0"),i=n.getFullYear();return t.replace("DD",o).replace("MM",r).replace("YYYY",i)}function P(e,t,n){if(!e)return!1;const o=e instanceof Date?e:new Date(e),r=t instanceof Date?t:new Date(t),i=n instanceof Date?n:new Date(n);return o>=r&&o<=i}function $(e,t){if(!e)return!1;const n=new Date(t,0,1),o=new Date(t,11,31);return!(e.startDate&&new Date(e.startDate)>o)&&!(e.endDate&&new Date(e.endDate)<n)}"undefined"!=typeof window&&(window.showConfirm=y,window.showAlert=E,window.showSuccess=b,window.showError=L,window.showErrorAlert=S,window.showInfo=D),"undefined"!=typeof window&&(window.showSpinner=I,window.hideSpinner=C),"undefined"!=typeof window&&(window.formatNumber=A,window.formatCurrency=R,window.parseDecimalWithComma=x,window.formatDecimalWithComma=k),"undefined"!=typeof window&&(window.escapeHtml=B),"undefined"!=typeof window&&(window.getMonthName=M,window.isEmployeeActiveInYear=$);class F{constructor(e){this.nrd=e,this.currentUser=null,this.authCheckComplete=!1,this.unsubscribe=null,this.init()}init(){this.nrd&&this.nrd.auth?(this.unsubscribe=this.nrd.auth.onAuthStateChanged(e=>{try{this.authCheckComplete=!0,this.currentUser=e,this.hideRedirectingScreen(),e?(n.logger.info("User authenticated, showing app screen",{uid:e.uid,email:e.email}),this.showAppScreen()):(n.logger.info("User not authenticated, showing login screen"),this.showLoginScreen())}catch(e){n.logger.error("Error in auth state change",e),this.hideRedirectingScreen();const t=document.getElementById("login-screen"),o=document.getElementById("app-screen");t&&t.classList.remove("hidden"),o&&o.classList.add("hidden")}}),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>this.initAuthCheck()):this.initAuthCheck(),this.setupLoginForm(),this.setupProfileHandlers()):(n.logger.error("nrd or nrd.auth is not available"),this.showRedirectingScreen(),setTimeout(()=>{this.hideRedirectingScreen(),this.showLoginScreen()},300))}showRedirectingScreen(){const e=document.getElementById("redirecting-screen"),t=document.getElementById("login-screen"),n=document.getElementById("app-screen");e&&e.classList.remove("hidden"),t&&t.classList.add("hidden"),n&&n.classList.add("hidden")}hideRedirectingScreen(){const e=document.getElementById("redirecting-screen");e&&e.classList.add("hidden")}hasStoredToken(){try{return Object.keys(localStorage).filter(e=>e.startsWith("firebase:authUser:")).length>0}catch(e){return n.logger.error("Error checking stored token",e),!1}}initAuthCheck(){this.showRedirectingScreen(),this.hasStoredToken()?(n.logger.debug("Stored token found, waiting for auth state change"),setTimeout(()=>{this.authCheckComplete||(n.logger.info("Token found but authentication not restored, showing login"),this.hideRedirectingScreen(),this.showLoginScreen())},2e3)):(n.logger.debug("No stored token found, showing login immediately"),setTimeout(()=>{this.hideRedirectingScreen(),this.showLoginScreen()},300))}showLoginScreen(){n.logger.debug("Showing login screen");try{const e=document.getElementById("login-screen"),t=document.getElementById("app-screen");e&&e.classList.remove("hidden"),t&&t.classList.add("hidden")}catch(e){n.logger.error("Error showing login screen",e)}}showAppScreen(){n.logger.debug("Showing app screen");try{const e=document.getElementById("login-screen"),t=document.getElementById("app-screen");e&&e.classList.add("hidden"),t&&t.classList.remove("hidden"),setTimeout(()=>{"function"==typeof window.switchView&&(n.logger.debug("Switching to default view: dashboard"),window.switchView("dashboard"))},100)}catch(e){n.logger.error("Error showing app screen",e)}}setupLoginForm(){const e=document.getElementById("login-form");e&&e.addEventListener("submit",async e=>{e.preventDefault();try{const e=document.getElementById("login-email")?.value,t=document.getElementById("login-password")?.value,o=document.getElementById("login-error");if(!e||!t)return n.logger.warn("Login attempt with empty fields"),void(o&&(o.textContent="Por favor complete todos los campos"));if(n.logger.info("Attempting user login",{email:e}),o&&(o.textContent=""),!this.nrd||!this.nrd.auth)return n.logger.error("nrd or nrd.auth is not available"),void(o&&(o.textContent="Error: Servicio no disponible"));I("Iniciando sesión...");const r=(await this.nrd.auth.signIn(e,t)).user;n.logger.audit("USER_LOGIN",{email:e,uid:r.uid,timestamp:Date.now()}),n.logger.info("User login successful",{uid:r.uid,email:e}),C()}catch(e){C(),n.logger.error("Login failed",e);const t=document.getElementById("login-error");t&&(t.textContent=e.message||"Error al iniciar sesión")}})}setupProfileHandlers(){const e=document.getElementById("profile-btn");e&&e.addEventListener("click",()=>{this.showProfileModal()});const t=document.getElementById("close-profile-modal");t&&t.addEventListener("click",()=>{this.closeProfileModal()});const o=document.getElementById("profile-logout-btn");o&&o.addEventListener("click",async()=>{try{const e=this.getCurrentUser();if(n.logger.info("Attempting user logout",{uid:e?.uid,email:e?.email}),this.closeProfileModal(),!this.nrd||!this.nrd.auth)return void n.logger.error("nrd or nrd.auth is not available");I("Cerrando sesión..."),await this.nrd.auth.signOut(),n.logger.audit("USER_LOGOUT",{uid:e?.uid,email:e?.email,timestamp:Date.now()}),n.logger.info("User logout successful"),C()}catch(e){C(),n.logger.error("Logout failed",e)}})}showProfileModal(){n.logger.debug("Showing profile modal");const e=document.getElementById("profile-modal"),t=document.getElementById("profile-modal-content");if(!e||!t)return void n.logger.warn("Profile modal elements not found");const o=this.getCurrentUser();if(!o)return void n.logger.warn("No user found when showing profile modal");n.logger.debug("Displaying user profile data",{uid:o.uid,email:o.email});let r=`\n      <div class="space-y-3 sm:space-y-4">\n        <div class="flex justify-between py-2 sm:py-3 border-b border-gray-200">\n          <span class="text-gray-600 font-light text-sm sm:text-base">Email:</span>\n          <span class="font-light text-sm sm:text-base">${B(o.email||"N/A")}</span>\n        </div>\n        ${o.displayName?`\n        <div class="flex justify-between py-2 sm:py-3 border-b border-gray-200">\n          <span class="text-gray-600 font-light text-sm sm:text-base">Nombre:</span>\n          <span class="font-light text-sm sm:text-base">${B(o.displayName)}</span>\n        </div>\n        `:""}\n      </div>\n    `;t.innerHTML=r,e.classList.remove("hidden"),n.logger.debug("Profile modal shown")}closeProfileModal(){n.logger.debug("Closing profile modal");const e=document.getElementById("profile-modal");e&&(e.classList.add("hidden"),n.logger.debug("Profile modal closed"))}getCurrentUser(){return this.nrd&&this.nrd.auth&&this.nrd.auth.getCurrentUser()||this.currentUser}destroy(){this.unsubscribe&&(this.unsubscribe(),this.unsubscribe=null)}}class V{constructor(){this.currentView=null,this.views=["dashboard","payroll-items"],this.viewHandlers=new Map}registerView(e,t){this.viewHandlers.set(e,t)}switchView(e){if(this.currentView===e)return void n.logger.debug("View already active, skipping",{viewName:e});n.logger.info("Switching view",{from:this.currentView,to:e}),this.currentView=e,this.views.forEach(e=>{const t=document.getElementById(`${e}-view`);t&&t.classList.add("hidden")});const t=document.getElementById(`${e}-view`);t?(t.classList.remove("hidden"),n.logger.debug("View shown",{viewName:e})):n.logger.warn("View element not found",{viewName:e}),document.querySelectorAll(".nav-btn").forEach(e=>{e.classList.remove("border-red-600","text-red-600","bg-red-50","font-medium"),e.classList.add("border-transparent","text-gray-600")});const o=document.querySelector(`[data-view="${e}"]`);o?(o.classList.remove("border-transparent","text-gray-600"),o.classList.add("border-red-600","text-red-600","bg-red-50","font-medium")):n.logger.warn("Active nav button not found",{viewName:e}),n.logger.debug("Loading view data",{viewName:e});const r=this.viewHandlers.get(e);r?r():"dashboard"===e?"function"==typeof window.initializeDashboard?window.initializeDashboard():"function"==typeof window.loadDashboard&&window.loadDashboard():"payroll-items"===e&&("function"==typeof window.initializePayrollItems?window.initializePayrollItems():"function"==typeof window.loadPayrollItems&&window.loadPayrollItems()),n.logger.debug("View switched successfully",{viewName:e})}setupNavButtons(){n.logger.debug("Setting up nav button handlers"),document.querySelectorAll(".nav-btn").forEach(e=>{const t=e.cloneNode(!0);e.parentNode.replaceChild(t,e),t.addEventListener("click",()=>{const e=t.dataset.view;n.logger.debug("Nav button clicked",{view:e}),this.switchView(e)})}),n.logger.debug("Nav button handlers attached")}getCurrentView(){return this.currentView}}function j(e=5e3){return new Promise((t,n)=>{const o=Date.now(),r=()=>{const i=window.nrd;i?t(i):Date.now()-o>=e?n(new Error("NRD instance not found")):setTimeout(r,100)};r()})}function z(e,t=null,n=5e3){return new Promise((o,r)=>{const i=Date.now(),s=()=>{const a=t||window.nrd;if(!a)return Date.now()-i>=n?void r(new Error("NRD instance not found")):void setTimeout(s,100);e.every(e=>void 0!==a[e])?o(a):Date.now()-i>=n?r(new Error(`Services not available after timeout: ${e.join(", ")}`)):setTimeout(s,100)};s()})}"undefined"!=typeof window&&(window.switchView=function(e){window.navigationService&&window.navigationService.switchView(e)});const _={Logger:i,LOG_LEVELS:o,createLogger:s,waitForGlobal:g,waitForAllScripts:m,waitForGlobals:h,verifyModules:w,initializeNRD:p,initializeApplication:v,showConfirm:y,showAlert:E,showError:L,showErrorAlert:S,showSuccess:b,showInfo:D,showWarning:N,showSpinner:I,hideSpinner:C,formatNumber:A,formatCurrency:R,formatDecimalWithComma:k,parseDecimalWithComma:x,escapeHtml:B,querySelectorSafe:T,createElement:O,getMonthName:M,formatDate:U,isEmployeeActiveInYear:$,AuthService:F,NavigationService:V,waitForNRD:j,waitForServices:z};return t})());